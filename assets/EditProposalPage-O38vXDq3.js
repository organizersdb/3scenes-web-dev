import{r as s,j as e,e as Q,R as X,A as _,f as Z,u as D,t as ee,L as se,S as te,T as ae,g as ie,h as $,B as b,M as ne,a as I,i as re,d as le}from"./index-DRR2ciDs.js";import{u as oe,a as ce,B as C,b as O}from"./Input-B6_56Pay.js";import{T as de}from"./Textarea-kr1sqQC7.js";import{M as xe}from"./index-CDqgC5ys.js";import{S as me}from"./Separator-C5vIcpzW.js";import{F as ue}from"./FullScreenLoading-Bp5CqUL4.js";import{S as he}from"./ScriptHeader-BeMvvwfA.js";const F=({register:n,fieldName:t,watch:r,placeholder:l,maxLength:a})=>{const[o,i]=s.useState(!1),d=r(t)||"";return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-end",children:[e.jsx("button",{className:`${o?"bg-[#e2e3e7]":"bg-[#f0f1f3]"} rounded-t px-2 py-1 text-xs`,type:"button",onClick:()=>i(!0),children:"預覽"}),e.jsx("button",{className:`${o?"bg-[#f0f1f3]":"bg-[#e2e3e7]"} rounded-t px-2 py-1 text-xs`,type:"button",onClick:()=>i(!1),children:"編輯"})]}),o?e.jsxs("div",{className:"w-full cursor-not-allowed border border-white bg-white p-2 focus:outline-none",children:[e.jsx("div",{className:"h-8 w-full"}),e.jsx(xe,{className:"markdown-preview",children:Q(d)})]}):e.jsxs("div",{children:[e.jsx("div",{className:"h-8 w-full bg-[#e2e3e7]"}),e.jsx("textarea",{rows:10,className:"w-full border border-[#f0f1f3] bg-white p-2 focus:outline-none",...n(t),value:d,placeholder:l}),e.jsx("div",{className:"flex justify-end",children:a&&e.jsxs("div",{className:"text-sm text-gray-500",children:[String(d).length," / ",a]})})]})]})},B=X.createContext({}),pe=({children:n})=>{const[t,r]=s.useState(je),{authFetch:l}=s.useContext(_),{createProposal:a,updateProposal:o}=s.useContext(Z),{id:i}=D(),d=s.useMemo(()=>ee(x=>{const m=x??t.proposal;return m.id?o(m).then(f=>(r(g=>({...g,proposal:f})),f)):a(m).then(f=>(r(g=>({...g,proposal:f})),f))},500),[a,o,t.proposal]);return s.useEffect(()=>{i?(r(x=>({...x,isLoading:!0})),l(`/proposal/view?id=${i}`).then(x=>x.json()).then(x=>{r(m=>({...m,proposal:x,isLoading:!1}))})):r(x=>({...x,proposal:JSON.parse(JSON.stringify(V)),isLoading:!1}))},[l,i]),t.isLoading?e.jsx(se,{}):e.jsx(B.Provider,{value:{...t,saveProposal:d},children:n})},fe={screenwriterId:"",highlight:"",title:"",tagline:"",logline:"",outline:"",category:"",duration:0,progress:"",status:"draft",author:[],scenes:[{no:"",time:"",location:"",content:""}]},V={jobId:"",isShortlisted:!1,isArchived:!1,screenwriterId:"",description:"",currency:"",details:"",script:fe},je={proposal:JSON.parse(JSON.stringify(V)),isLoading:!0},ge=({proposal:n,job:t,script:r,screenwriter:l})=>{var T,E;const{saveScript:a}=s.useContext(te),{saveProposal:o}=s.useContext(B),{showAlert:i}=s.useContext(ae),d=ie(),[x,m]=s.useState(!1),[f,g]=s.useState(!1),[k,L]=s.useState(!1),N=l==null?void 0:l.id,J=n&&{...n,script:r},{register:h,control:Y,formState:{errors:j},handleSubmit:P,watch:p,trigger:A}=oe({mode:"onChange",defaultValues:J}),{fields:v,append:H,remove:W}=ce({control:Y,name:"script.scenes"}),R=s.useCallback(()=>{d("/acknowledgement",{state:{initialCountdown:3,heading:"你已成功投稿劇本！",paragraphs:["電影公司將收到通知。","如有任何查詢，請聯絡 info@3scenes.io"],countdownText:"頁面將於{countdown}秒後返回 Dashboard",redirectPath:"/dashboard"}})},[d]),w=s.useCallback(()=>{m(!1),i({severity:"ERROR",content:"抱歉，系統遇到技術問題，請稍後重試。若問題持續，請與我們聯絡。"})},[i]),S=s.useCallback(async(c,u)=>{if(N)try{const y={...c.script,screenwriterId:N,status:u},M=await a(y);if(!M.id){w();return}const{script:we,...K}=c;if(!(await o({...K,jobId:t.id,screenwriterId:N,scriptId:M.id,status:u})).id){w();return}u==="submitted"?R():i({severity:"SUCCESS",content:"草稿已成功儲存"})}catch{w()}},[N,a,o,t.id,w,R,i]),z=s.useCallback(()=>{m(!0)},[]),U=s.useCallback(async c=>{try{L(!0),await S(c,"submitted")}finally{L(!1)}},[S]),G=s.useCallback(async c=>{try{g(!0),await S(c,"draft")}finally{g(!1)}},[S]);return!t||k?e.jsx(ue,{}):e.jsxs("form",{children:[e.jsxs("section",{className:"font-sans text-xl",children:["應徵活動：",e.jsx("b",{children:t.title})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("section",{id:"scenes",children:[e.jsx($,{text:"三場劇本"}),e.jsx("div",{className:"flex flex-col gap-y-12",children:v==null?void 0:v.map((c,u)=>e.jsxs("div",{className:"border border-black p-12",children:[e.jsxs("header",{className:"grid lg:grid-cols-[200px_1fr]",children:[e.jsxs("div",{className:"flex",children:[e.jsx(C,{className:"w-[80px]",textAlign:"center",fieldName:`script.scenes[${u}].no`,register:h,watch:p,errors:j,placeholder:"場",maxLength:2}),e.jsx("div",{className:"mx-2 mt-9 h-[3rem] border-r-2 border-black"}),e.jsx(C,{className:"w-[80px]",textAlign:"center",fieldName:`script.scenes[${u}].time`,register:h,watch:p,errors:j,placeholder:"時",maxLength:2})]}),e.jsx(C,{className:"w-auto max-w-[500px] justify-self-end",fieldName:`script.scenes[${u}].location`,register:h,watch:p,errors:j,placeholder:"景",maxLength:10})]}),e.jsxs("div",{className:"pt-16 text-3xl leading-[3rem]",children:[e.jsx(F,{fieldName:`script.scenes[${u}].content`,register:h,watch:p}),u>0&&e.jsx(b,{size:"small",text:"刪除場景",onClick:y=>{y.preventDefault(),W(u)}})]})]},c.no))}),(v==null?void 0:v.length)<3&&e.jsx("div",{className:"flex justify-end",children:e.jsx(b,{icon:e.jsx(ve,{}),iconPosition:"left",className:"mt-12",text:"新增場景",onClick:c=>{c.preventDefault(),H({no:"",time:"",location:"",content:""})}})})]}),e.jsxs("section",{id:"outline",children:[e.jsx($,{text:"劇本資料"}),e.jsxs("div",{className:"notched-corner-top-right border border-black p-10",children:[e.jsxs("header",{children:[e.jsx("div",{className:"flex items-end justify-between",children:e.jsx("h2",{className:"text-5xl font-semibold",children:e.jsx(C,{fieldName:"script.title",register:h,watch:p,errors:j,placeholder:"劇本名稱",maxLength:10,validation:{required:"請輸入劇本名稱"}})})}),e.jsx(me,{className:"my-1"}),e.jsxs("div",{className:"flex justify-between font-sans font-light text-gray-500",children:[e.jsxs("span",{children:["類型：",(T=t.categories)==null?void 0:T.join("、")]}),e.jsx("span",{children:(E=t.collabMode)==null?void 0:E.join("、")})]})]}),e.jsx("div",{className:"mt-16",children:e.jsx(O,{fieldName:"script.tagline",register:h,watch:p,placeholder:"宣傳標語",maxLength:50,errors:j,validation:{required:"請輸入宣傳標語",maxLength:{value:50,message:"最多輸入50字"}}})}),e.jsx("div",{className:"mt-16",children:e.jsx(de,{fieldName:"script.logline",register:h,watch:p,placeholder:"故事梗概",maxLength:100,errors:j,validation:{required:"請輸入故事梗概",maxLength:{value:100,message:"最多輸入100字"}}})}),e.jsx("div",{className:"mt-12 text-3xl leading-[3rem]",children:e.jsx(F,{fieldName:"script.outline",register:h,watch:p,placeholder:"故事大綱",maxLength:500})})]}),e.jsx("div",{className:"mt-12 flex justify-center",children:e.jsxs("div",{className:"min-w-[450px]",children:[e.jsx("h3",{className:"font-sans font-bold",children:"你的期望薪金？"}),e.jsx("p",{children:`此項目以${t.rate}`}),e.jsx("div",{children:e.jsx(O,{prefix:t.currency,className:"mt-7",fieldName:"offer",register:h,watch:p,type:"number",errors:j,label:"填寫你的期望薪金",validation:{required:"請填寫你的期望薪金"}})})]})})]}),e.jsxs("div",{className:"flex justify-center gap-x-8 py-10",children:[e.jsx(b,{text:"儲存草稿",onClick:async()=>{await A("script.title")&&P(G)()},disabled:f}),e.jsx(b,{text:"提交",className:"border-indigo bg-indigo text-white",onClick:async()=>{await A()&&P(z)()},disabled:k})]}),e.jsx(ne,{isOpen:x,onClose:()=>m(!1),children:e.jsxs("div",{className:"mx-auto flex flex-col items-center gap-y-2 py-10 text-center",children:[e.jsx("div",{className:"font-serif text-3xl font-bold",children:"你確定要投稿嗎？"}),e.jsx("div",{className:"font-light",children:"徵稿方將會收到投稿資料"}),e.jsxs("div",{className:"flex gap-x-3",children:[e.jsx(b,{text:"返回",type:"button",onClick:()=>m(!1)}),e.jsx(b,{className:"border-indigo bg-indigo text-white",text:"提交",type:"button",onClick:P(U),disabled:k})]})]})})]})]})},ve=()=>e.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 13 13",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("line",{x1:"6.16992",y1:"2.18557e-08",x2:"6.16992",y2:"13",stroke:"black"}),e.jsx("line",{y1:"6.84778",x2:"13",y2:"6.84778",stroke:"black"})]}),q={screenwriterId:"",highlight:"",title:"",tagline:"",logline:"",outline:"",category:"",duration:0,progress:"",status:"draft",author:[],scenes:[{no:"",time:"",location:"",content:""}]},be={jobId:"",isShortlisted:!1,isArchived:!1,screenwriterId:"",description:"",currency:"",details:"",script:q},Ne=[{anchor:"scenes",text:"三場劇本"},{anchor:"outline",text:"劇本資料"}],Re=()=>{const{id:n,jobId:t}=D(),{authUser:r,authSwrFetcher:l}=s.useContext(_),{data:a}=I(n?`/proposal/view?id=${n}`:null,l),{data:o}=I(`/job/view?id=${(a==null?void 0:a.jobId)||t}`,l),{data:i}=I(a!=null&&a.scriptId?`/script/view?id=${a.scriptId}`:null,l),d=r==null?void 0:r.screenwriter;return!d||!o?null:e.jsx(pe,{children:e.jsx(re,{children:e.jsxs("div",{className:"mt-24 font-serif",children:[e.jsx(he,{text:n?"編輯投稿":"劇本投稿"}),e.jsxs("div",{className:"grid md:grid-cols-12 md:px-12 md:py-32",children:[e.jsx("aside",{className:"sticky top-12 col-span-3 hidden self-start md:block",children:e.jsx(le,{anchors:Ne})}),e.jsx("div",{className:"col-span-9",children:e.jsx(ge,{job:o,script:n&&i?i:q,proposal:n&&a?a:be,screenwriter:d})})]})]})})})};export{Re as default};
