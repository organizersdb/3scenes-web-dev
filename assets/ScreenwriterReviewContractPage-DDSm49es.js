import{u as H,r as i,A as J,T as K,Q as X,g as Y,a as w,j as e,B as o,k as Z,M}from"./index-DRR2ciDs.js";import{S as c}from"./SectionTitle-D1bwP6RQ.js";import{u as U}from"./Input-B6_56Pay.js";import{C as T,a as ee,b as te,c as se,d as ne,e as ae}from"./ContractWorkscope-CQXnVUha.js";import{S as ie}from"./Separator-C5vIcpzW.js";import{F as oe}from"./FullScreenLoading-Bp5CqUL4.js";import"./RadioGroup-B9-TZJ69.js";const fe=()=>{var v,k,R,S,F,P;const{contractId:A}=H(),{authUser:s,authSwrFetcher:j}=i.useContext(J),{showAlert:x}=i.useContext(K),{saveContract:m}=i.useContext(X),b=Y(),[B,r]=i.useState(!1),[E,d]=i.useState(!1),p=i.useRef(null),[L,f]=i.useState(!1),{data:t}=w(`/contract/view?id=${A}`,j),{data:n}=w(t?`/job/view?id=${t.jobId}`:null,j),{data:h}=w(t!=null&&t.contractFileId?`/file/get?id=${t.contractFileId}`:null,j),{register:y,trigger:D,handleSubmit:V,watch:C,formState:{errors:$}}=U({mode:"onChange",defaultValues:t}),{ref:q,...W}=y("contractFile"),l=C("contractFile"),N=l&&l.length>0?l[0]:null,u=i.useCallback(async({heading:a})=>{b("/acknowledgement",{state:{initialCountdown:3,heading:a,paragraphs:["如有任何查詢，請聯絡 info@3scenes.io"],countdownText:"頁面將於{countdown}秒後返回 Dashboard",redirectPath:"/dashboard"}})},[b]),Q=i.useCallback(()=>{d(!0)},[]),_=i.useCallback(async()=>{r(!0),f(!0);const a=await m({id:t==null?void 0:t.id,status:"rejected by screenwriter"});f(!1),a.id?u({heading:"你已拒絕簽署合約！"}):(r(!1),x({severity:"ERROR",content:"抱歉，系統遇到技術問題，請稍後重試。若問題持續，請與我們聯絡。"}))},[t==null?void 0:t.id,u,m,x]),z=i.useCallback(async a=>{var O;d(!0),f(!0);const I={id:t.id,status:"in-force",receipientBankInfo:a.receipientBankInfo};(O=p.current)!=null&&O.files&&(I.contractFile=[p.current.files[0]]);const G=await m(I);f(!1),G.id?u({heading:"你已確定簽署合約！"}):(d(!1),x({severity:"ERROR",content:"抱歉，系統遇到技術問題，請稍後重試。若問題持續，請與我們聯絡。"}))},[t,u,m,x]);if(!t||!n||!s||L)return e.jsx(oe,{});const g=h?"upload":"draft";return e.jsxs("form",{className:"flex max-w-2xl flex-col justify-center",children:[e.jsx("h1",{className:"text-center font-sans text-xl font-bold md:text-left md:text-3xl",children:h?"電影公司上載了此合約":"審核合約"}),e.jsxs("p",{className:"mt-4",children:["你必須在5天內審核合約，否則此合作會被取消。",g==="upload"&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"此合約非透過3scenes 草擬，你必須先下載文件，簽署後重新上載。"]})]}),e.jsx(ie,{}),g==="upload"?e.jsxs("div",{className:"flex gap-x-4",children:[e.jsx(o,{text:"下載合約",onClick:()=>window.open(h,"_blank")}),e.jsx(o,{text:l&&l.length>0?l[0].name:"上載合約",onClick:()=>{var a;(a=p.current)==null||a.click()}}),e.jsx("input",{type:"file",style:{display:"none"},accept:"application/pdf",...W,ref:a=>{q(a),p.current=a}})]}):e.jsxs("div",{className:"flex max-w-lg flex-col gap-y-16 md:ml-32",children:[e.jsxs("section",{className:"leading-8",children:[e.jsx(c,{current:1,total:6,title:"委託方／受託方資料"}),e.jsx(T,{title:"委託方",name:(v=n==null?void 0:n.company)==null?void 0:v.name,contactPerson:(k=n==null?void 0:n.company)==null?void 0:k.contactPerson,phone:(R=n==null?void 0:n.company)==null?void 0:R.phone,br:(S=n==null?void 0:n.company)==null?void 0:S.br,partyType:"甲方"}),e.jsx(T,{title:"受託方",name:s==null?void 0:s.displayName,contactPerson:(F=s==null?void 0:s.screenwriter)==null?void 0:F.contactPerson,phone:s==null?void 0:s.mobile,br:(P=s==null?void 0:s.screenwriter)==null?void 0:P.br,partyType:"乙方"})]}),e.jsxs("section",{className:"leading-8",children:[e.jsx(c,{current:2,total:6,title:"合約目的"}),e.jsx(ee,{mode:"view",copyrightOwner:t.copyrightOwner})]}),e.jsxs("section",{className:"leading-8",children:[e.jsx(c,{current:3,total:6,title:"工作內容及要求"}),e.jsx(te,{})]}),e.jsxs("section",{className:"leading-8",children:[e.jsx(c,{current:4,total:6,title:"工作成果、進度及交付要求"}),e.jsx(se,{watch:C,register:y,mode:"view",prototypeRequirements:t.prototypeRequirements})]}),e.jsxs("section",{className:"leading-8",children:[e.jsx(c,{current:5,total:6,title:"服務費及支付"}),e.jsx(ne,{watch:C,register:y,mode:"screenwriter-draft",paymentSchedules:t.paymentSchedules,errors:$})]}),e.jsxs("section",{className:"leading-8",children:[e.jsx(c,{current:6,total:6,title:"權利和義務"}),e.jsx(ae,{})]})]}),e.jsxs("section",{className:"flex justify-center gap-x-8 py-10",children:[e.jsx(o,{text:"拒絕簽署",onClick:()=>r(!0)}),e.jsx(o,{className:Z({"border-indigo bg-indigo text-white":!0,"border-gray-500 bg-gray-500 text-white":g==="upload"&&!N}),disabled:g==="upload"&&!N,text:"確認簽署",onClick:async()=>{await D()&&Q()}})]}),e.jsx(M,{isOpen:B,onClose:()=>r(!1),children:e.jsxs("div",{className:"mx-auto flex flex-col items-center gap-y-2 py-10 text-center",children:[e.jsx("div",{className:"font-serif text-3xl font-bold",children:"你確定拒絕簽署合約嗎？"}),e.jsx("div",{className:"font-light",children:"甲方將收到拒簽通知，你不能再參與此項目"}),e.jsx("div",{className:"font-light",children:"如需協助，請聯絡 info@3scenes.io"}),e.jsxs("div",{className:"flex gap-x-3",children:[e.jsx(o,{text:"返回",type:"button",onClick:()=>r(!1)}),e.jsx(o,{className:"border-indigo bg-indigo text-white",text:"拒絕簽署",type:"button",onClick:_})]})]})}),e.jsx(M,{isOpen:E,onClose:()=>d(!1),children:e.jsxs("div",{className:"mx-auto flex flex-col items-center gap-y-2 py-10 text-center",children:[e.jsx("div",{className:"font-serif text-3xl font-bold",children:"你確定簽署合約嗎？"}),e.jsx("div",{className:"font-light",children:"簽署合約後，將等待甲方支付開筆費"}),e.jsxs("div",{className:"flex gap-x-3",children:[e.jsx(o,{text:"返回",type:"button",onClick:()=>d(!1)}),e.jsx(o,{className:"border-indigo bg-indigo text-white",text:"確認簽署",type:"button",onClick:V(z)})]})]})})]})};export{fe as default};
